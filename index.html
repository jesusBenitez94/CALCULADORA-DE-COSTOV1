<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Calculadora de Costo - Jesus Benitez</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      padding-top: 2rem;
      padding-bottom: 3rem;
      background: linear-gradient(180deg, #f7fafc 0%, #eef2f7 100%);
      min-height: 100vh;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }
    .tax-list small { white-space: pre-line; }
    .value-large { font-size: 1.35rem; font-weight: 700; }
    @media (max-width: 575px) {
      .value-large { font-size: 1.15rem; }
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h3 class="mb-0">Calculadora de Costo</h3>
              <small class="text-muted">by JESUS BENITEZ — v.4 (Lista Simple)</small>
            </div>
            <div class="text-end">
              <button id="fullscreenBtn" class="btn btn-outline-secondary btn-sm">Pantalla completa</button>
            </div>
          </div>

          <div class="row g-3">
            
            <div class="col-md-8">
              <label for="categoria" class="form-label">Categoría</label>
              <select id="categoria" class="form-select">
                </select>
            </div>
            <div class="col-md-4">
              <label for="precioNeto" class="form-label">Costo s/iva o C/iva</label>
              <input id="precioNeto" type="text" class="form-control" placeholder="Ej: 1234.56" inputmode="decimal">
            </div>

            <div class="col-12">
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-success" data-rate="0.21" data-name="IVA 21%">Aplicar IVA (21%)</button>
                <button class="btn btn-primary" data-rate="0.105" data-name="10.5%">Aplicar 10,5%</button>
                <button class="btn btn-warning text-dark" data-rate="0.03" data-name="IIBB 3%">Aplicar IIBB (3%)</button>
                <button class="btn btn-purple" id="imp15Btn" style="background:#9C27B0;color:white;" data-rate="0.015" data-name="IMPUESTOS 1.5%">IMPUESTOS 1,5%</button>
                <button id="calcularBtn" class="btn btn-secondary">Calcular</button>
                <button id="descargarPdfBtn" class="btn btn-danger">Descargar PDF</button>
                <button id="limpiarBtn" class="btn btn-outline-dark">Limpiar</button>
                <button id="refrescarBtn" class="btn btn-outline-primary">Refrescar</button>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mt-3 p-3 bg-white rounded-3">
                <h6 class="mb-2">Impuestos aplicados</h6>
                <div id="impuestosAplicados" class="tax-list text-muted small">— No hay impuestos aplicados —</div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mt-3 p-3 bg-white rounded-3">
                <h6 class="mb-2">Resumen</h6>
                <div class="d-flex justify-content-between">
                  <div>Precio costo (con impuestos):</div>
                  <div id="precioConImpuestos" class="value-large">—</div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <div>Margen aplicado:</div>
                  <div id="margenTexto" class="text-muted">—</div>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                  <div class="fw-bold">Precio Final:</div>
                  <div id="precioFinal" class="value-large text-success">—</div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <small class="text-muted">Consejos: ingresa números positivos. Los impuestos se suman al precio neto y luego se aplica el margen de la categoría.</small>
            </div>
          </div>
        </div>

        <footer class="text-center mt-3 text-muted small">
          Generado por Jesus Benitez
        </footer>
      </div>
    </div>
  </main>

  <script>
  // MODIFICACIÓN: Mapa de categorías simple (plano) con tu nueva lista
  const CATEGORIAS_MARGEN = {
    "Alimentos": 0.58,
    "Analgesicos": 1.00,
    "Cervezas": 0.63,
    "Vinos": 0.53,
    "Tabaco": 0.60,
    "Bebidas Blancas": 0.63,
    "Espumantes": 0.60,
    "Jugo Liquidos / Jugos en Polvo": 0.58,
    "Gaseosas, Aguas Saborizadas": 0.48, // Tomando 48%
    "Congelados": 0.60,
    "Lacteos": 0.48, // Tomando 48%
    "Caramelos, Chicles": 0.78,
    "Chocolates": 0.68,
    "Galletitas": 0.68,
    "Alfajores": 0.68,
    "Bazar": 0.60,
    "Jugueteria": 0.78,
    "Limpieza": 0.60,
    "Higiene Personal, Farmacia, Cuidado Fem.": 0.60,
    "Panificados (Tostadas, bizcochitos, pan, etc)": 0.40,
    "Fiombreria": 0.50,
    "Snacks (Papas fritas, Mani, Palitos salados, etc)": 0.68,
    "Helados / Postres": 0.58,
    "Combos y promociones": 0.30,
    "Hielos": 1.00,
    "Cigarrillos": 0.23
  };
  // FIN DE LA MODIFICACIÓN

  // Estado
  let netPrice = null;
  const appliedTaxes = {}; // { "IVA 21%": amount, ... }

  // MODIFICACIÓN: Elementos DOM
  const categoriaEl = document.getElementById('categoria'); // Un solo selector
  const precioNetoEl = document.getElementById('precioNeto');
  const impuestosAplicadosEl = document.getElementById('impuestosAplicados');
  const precioConImpuestosEl = document.getElementById('precioConImpuestos');
  const precioFinalEl = document.getElementById('precioFinal');
  const margenTextoEl = document.getElementById('margenTexto');
  const botonesImpuestos = document.querySelectorAll('button[data-rate]');
  const calcularBtn = document.getElementById('calcularBtn');
  const descargarPdfBtn = document.getElementById('descargarPdfBtn');
  const limpiarBtn = document.getElementById('limpiarBtn');
  const refrescarBtn = document.getElementById('refrescarBtn');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  // FIN MODIFICACIÓN

  // MODIFICACIÓN: Rellenar el selector único
  function initCategorias() {
    // Iterar sobre el objeto plano
    Object.entries(CATEGORIAS_MARGEN).forEach(([catName, margin]) => {
      const opt = document.createElement('option');
      opt.value = catName; // El valor es el nombre (clave)
      const marginPercent = (margin * 100).toFixed(0);
      // El texto es "Nombre (X%)"
      opt.textContent = `${catName} (${marginPercent}%)`;
      categoriaEl.appendChild(opt);
    });
    
    // Opcional: seleccionar la primera categoría por defecto
    if (categoriaEl.options.length > 0) {
       categoriaEl.selectedIndex = 0;
    }
  }

  function parsePrice(value) {
    if (!value) return null;
    const normalized = String(value).trim().replace(/\s+/g, '').replace(',', '.');
    const v = Number(normalized);
    if (Number.isFinite(v) && v >= 0) return v;
    return null;
  }

  function formatCurrency(num) {
    if (num === null || num === undefined || !Number.isFinite(num)) return '—';
    return num.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 2 });
  }

  function showImpuestos() {
    if (Object.keys(appliedTaxes).length === 0) {
      impuestosAplicadosEl.textContent = '— No hay impuestos aplicados —';
      return;
    }
    const lines = Object.entries(appliedTaxes).map(([name, amount]) => `${name}: +${formatCurrency(amount)}`);
    impuestosAplicadosEl.innerHTML = '<small>' + lines.join('\n') + '</small>';
  }

  // MODIFICACIÓN: Actualizar display con un solo selector
  function updateDisplay() {
    const parsedPrice = parsePrice(precioNetoEl.value);
    if (parsedPrice !== null) {
      netPrice = parsedPrice;
    }

    if (netPrice === null) {
      precioConImpuestosEl.textContent = '—';
      precioFinalEl.textContent = '—';
      margenTextoEl.textContent = '—';
      showImpuestos();
      return;
    }

    const totalTax = Object.values(appliedTaxes).reduce((a,b) => a + b, 0);
    const priceWithTaxes = netPrice + totalTax;

    const category = categoriaEl.value; // Obtener valor del único selector

    if (!category) {
      precioFinalEl.textContent = '—';
      margenTextoEl.textContent = 'Seleccione categoría';
      precioConImpuestosEl.textContent = formatCurrency(priceWithTaxes);
      return;
    }

    const margin = CATEGORIAS_MARGEN[category] ?? 0; // Buscar en el objeto plano
    const finalPrice = priceWithTaxes * (1 + margin);

    precioConImpuestosEl.textContent = formatCurrency(priceWithTaxes);
    precioFinalEl.textContent = formatCurrency(finalPrice);
    
    // Acortar nombre si es muy largo para el display
    const catDisplay = category.length > 30 ? category.substring(0, 27) + '...' : category;
    margenTextoEl.textContent = `${(margin*100).toFixed(0)}% (${catDisplay})`;

    showImpuestos();
  }

  function applyTax(name, rate) {
    const parsed = parsePrice(precioNetoEl.value);
    if (parsed === null) {
      alert('Ingrese un precio neto válido antes de aplicar impuestos.');
      return;
    }
    netPrice = parsed; 

    if (appliedTaxes.
