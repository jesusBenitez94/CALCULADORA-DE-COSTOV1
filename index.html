<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Calculadora de Costo - Jesus Benitez</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      padding-top: 2rem;
      padding-bottom: 3rem;
      background: linear-gradient(180deg, #f7fafc 0%, #eef2f7 100%);
      min-height: 100vh;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }
    .tax-list small { white-space: pre-line; }
    .value-large { font-size: 1.35rem; font-weight: 700; }
    @media (max-width: 575px) {
      .value-large { font-size: 1.15rem; }
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h3 class="mb-0">Calculadora de Costo</h3>
              <small class="text-muted">by JESUS BENITEZ — v.3 (Lista Completa)</small>
            </div>
            <div class="text-end">
              <button id="fullscreenBtn" class="btn btn-outline-secondary btn-sm">Pantalla completa</button>
            </div>
          </div>

          <div class="row g-3">
            
            <div class="col-md-4">
              <label for="categoriaPrincipal" class="form-label">Categoría Principal</label>
              <select id="categoriaPrincipal" class="form-select">
                </select>
            </div>
            
            <div class="col-md-4">
              <label for="subCategoria" class="form-label">Sub-Categoría</label>
              <select id="subCategoria" class="form-select">
                </select>
            </div>

            <div class="col-md-4">
              <label for="precioNeto" class="form-label">Costo s/iva o C/iva</label>
              <input id="precioNeto" type="text" class="form-control" placeholder="Ej: 1234.56" inputmode="decimal">
            </div>

            <div class="col-12">
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-success" data-rate="0.21" data-name="IVA 21%">Aplicar IVA (21%)</button>
                <button class="btn btn-primary" data-rate="0.105" data-name="10.5%">Aplicar 10,5%</button>
                <button class="btn btn-warning text-dark" data-rate="0.03" data-name="IIBB 3%">Aplicar IIBB (3%)</button>
                <button class="btn btn-purple" id="imp15Btn" style="background:#9C27B0;color:white;" data-rate="0.015" data-name="IMPUESTOS 1.5%">IMPUESTOS 1,5%</button>
                <button id="calcularBtn" class="btn btn-secondary">Calcular</button>
                <button id="descargarPdfBtn" class="btn btn-danger">Descargar PDF</button>
                <button id="limpiarBtn" class="btn btn-outline-dark">Limpiar</button>
                <button id="refrescarBtn" class="btn btn-outline-primary">Refrescar</button>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mt-3 p-3 bg-white rounded-3">
                <h6 class="mb-2">Impuestos aplicados</h6>
                <div id="impuestosAplicados" class="tax-list text-muted small">— No hay impuestos aplicados —</div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mt-3 p-3 bg-white rounded-3">
                <h6 class="mb-2">Resumen</h6>
                <div class="d-flex justify-content-between">
                  <div>Precio costo (con impuestos):</div>
                  <div id="precioConImpuestos" class="value-large">—</div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <div>Margen aplicado:</div>
                  <div id="margenTexto" class="text-muted">—</div>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                  <div class="fw-bold">Precio Final:</div>
                  <div id="precioFinal" class="value-large text-success">—</div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <small class="text-muted">Consejos: ingresa números positivos. Los impuestos se suman al precio neto y luego se aplica el margen de la categoría.</small>
            </div>
          </div>
        </div>

        <footer class="text-center mt-3 text-muted small">
          Generado por Jesus Benitez
        </footer>
      </div>
    </div>
  </main>

  <script>
  // MODIFICACIÓN: Mapa de categorías anidado actualizado con tu lista completa
  const CATEGORIAS_ANIDADAS = {
    "ALMACEN": {
      "ALMACEN (General)": 0.58,
      "ALMACEN / ACEITES, CONDIMENTOS Y ESPECIAS": 0.58,
      "ALMACEN / ADEREZOS Y SALSAS": 0.58,
      "ALMACEN / ARROZ, PASTAS SECAS": 0.58,
      "ALMACEN / CONSERVAS": 0.58,
      "ALMACEN / ENDULZANTES": 0.58,
      "ALMACEN / GALLETITAS": 0.68,
      "ALMACEN / HARINAS": 0.58,
      "ALMACEN / INFUSIONES": 0.58,
      "ALMACEN / JUGOS EN POLVOS": 0.58,
      "ALMACEN / MERMELADAS Y DULCES": 0.58,
      "ALMACEN / PANADERIA": 0.48,
      "ALMACEN / REPOSTERIA Y POSTRES": 0.58,
      "ALMACEN / SNACKS Y CEREALES": 0.68,
      "ALMACEN / SOPAS, CALDOS, PURÉS Y SABORIZADOS": 0.60
    },
    "BEBIDAS": {
      "BEBIDAS CON ALCOHOL (General)": 0.63,
      "BEBIDAS CON ALCOHOL / APERITIVOS": 0.63,
      "BEBIDAS CON ALCOHOL / BEBIDAS BLANCAS": 0.63,
      "BEBIDAS CON ALCOHOL / CHAMPAGNE Y ESPUMANTES": 0.60,
      "BEBIDAS CON ALCOHOL / VINOS": 0.53,
      "BEBIDAS CON ALCOHOL / WHISKY": 0.63,
      "BEBIDAS SIN ALCOHOL (General)": 0.58,
      "BEBIDAS SIN ALCOHOL / AGUAS (58% FLIARES 68% INDIV)": 0.58,
      "BEBIDAS SIN ALCOHOL / AGUAS SABORIZADAS (FLIARES 48% INDIVI 58%)": 0.48,
      "BEBIDAS SIN ALCOHOL / GASEOSAS (48% Fliares v 58% Indiv v Ret 30%)": 0.48,
      "BEBIDAS SIN ALCOHOL / ISOTONICAS / ENERGIZANTES": 0.58,
      "BEBIDAS SIN ALCOHOL / JUGOS": 0.58,
      "CERVEZAS (de seccion Otros)": 0.48 // Movido de 'Otros'
    },
    "OTROS": {
      "CARBON - LEÑA": 0.60,
      "COMBOS Y PROMOCIONES": 0.30,
      "Indefinido (de Kiosco)": 0.58
    },
    "CONGELADOS": {
      "CONGELADOS / COMIDAS CONGELADAS": 0.58,
      "CONGELADOS / FRUTAS CONGELADAS": 0.60,
      "CONGELADOS / HELADOS Y POSTRES": 0.58,
      "CONGELADOS / NUGGETS, PATITAS Y BOCADITOS": 0.60,
      "CONGELADOS / VEGETALES CONGELADOS": 0.60
    },
    "FRESCOS": {
      "FRESCOS (General)": 0.50,
      "FRESCOS / AVES": 0.50,
      "FRESCOS / CARNICERIA": 0.50,
      "FRESCOS / FIAMBRES": 0.50,
      "FRESCOS / FRUTAS Y VERDURAS": 0.50,
      "FRESCOS / HUEVOS": 0.58,
      "FRESCOS / LACTEOS (FLIARES 48% INDIVI 58%)": 0.48, // Tomando 48%
      "FRESCOS / PASTAS FRESCAS": 0.58,
      "FRESCOS / PESCADERIA": 0.50,
      "FRESCOS / QUESOS": 0.50,
      "FRESCOS / SANDWICHES": 0.50
    },
    "GASTRONOMIA": {
      "GASTRONOMIA (General - SE MANTIENE)": 0.00, // Margen 0
      "GASTRONOMIA / CAFETERIA": 0.50,
      "GASTRONOMIA / POSTRES": 0.58
    },
    "HOGAR": {
      "HOGAR (General)": 0.60,
      "HOGAR / ACCESORIOS DE ILUMINACION Y ELECTRICIDAD": 0.60,
      "HOGAR / BAZAR": 0.60,
      "HOGAR / JUGUETERIA": 0.78,
      "HOGAR / MASCOTAS": 0.60
    },
    "KIOSCO": {
      "KIOSCO / GOLOSINAS (General)": 0.68,
      "KIOSCO / GOLOSINAS / ALFAJORES": 0.68,
      "KIOSCO / GOLOSINAS / CARAMELOS Y CHUPETINES": 0.78,
      "KIOSCO / GOLOSINAS / CHICLES Y PASTILLAS": 0.78,
      "KIOSCO / GOLOSINAS / CHOCOLATES": 0.68,
      "KIOSCO / GOLOSINAS / GOMITAS Y GELATINAS": 0.68,
      "KIOSCO / GOLOSINAS / HIELOS": 1.00, // 100%
      "KIOSCO / GOLOSINAS / TURRONES, OBLEAS, BARRITAS DE CEREAL": 0.68
    },
    "LIMPIEZA": {
      "LIMPIEZA (General)": 0.60,
      "LIMPIEZA / ACCESORIOS DE LIMPIEZA": 0.60,
      "LIMPIEZA / CALZADOS": 0.60,
      "LIMPIEZA / DESODORANTES DE AMBIENTE": 0.60,
      "LIMPIEZA / INSECTICIDAS": 0.60,
      "LIMPIEZA / LAVADO": 0.60,
      "LIMPIEZA / LIMPIEZA DE BAÑO": 0.60,
      "LIMPIEZA / LIMPIEZA DE COCINA": 0.60,
      "LIMPIEZA / LIMPIEZA DE PISOS Y SUPERFICIES": 0.60,
      "LIMPIEZA / PAPELES": 0.60
    },
    "PANADERIA": {
      "PANES": 0.40,
      "PANIFICADORA TRIGO SRL": 0.40
    },
    "PERFUMERIA Y FARMACIA": {
      "PERFUMERIA / FARMACIA (General)": 0.60,
      "PERFUMERIA / FARMACIA / ANALGESICOS": 1.00, // 100%
      "PERFUMERIA / FARMACIA / COSMETICOS": 0.60,
      "PERFUMERIA / FARMACIA / CUIDADO BUCAL": 0.60,
      "PERFUMERIA / FARMACIA / CUIDADO DE LA PIEL": 0.60,
      "PERFUMERIA / FARMACIA / CUIDADO DEL CABELLO": 0.60,
      "PERFUMERIA / FARMACIA / CUIDADO PERSONAL": 0.60,
      "PERFUMERIA / FARMACIA / DESODORANTES": 0.60,
      "PERFUMERIA / FARMACIA / HIGIENE PERSONAL": 0.60
    }
  };
  // FIN DE LA MODIFICACIÓN


  // Estado
  let netPrice = null;
  const appliedTaxes = {}; // { "IVA 21%": amount, ... }

  // Elementos DOM
  const categoriaPrincipalEl = document.getElementById('categoriaPrincipal');
  const subCategoriaEl = document.getElementById('subCategoria');
  const precioNetoEl = document.getElementById('precioNeto');
  const impuestosAplicadosEl = document.getElementById('impuestosAplicados');
  const precioConImpuestosEl = document.getElementById('precioConImpuestos');
  const precioFinalEl = document.getElementById('precioFinal');
  const margenTextoEl = document.getElementById('margenTexto');
  const botonesImpuestos = document.querySelectorAll('button[data-rate]');
  const calcularBtn = document.getElementById('calcularBtn');
  const descargarPdfBtn = document.getElementById('descargarPdfBtn');
  const limpiarBtn = document.getElementById('limpiarBtn');
  const refrescarBtn = document.getElementById('refrescarBtn');
  const fullscreenBtn = document.getElementById('fullscreenBtn');

  function populateSubCategorias() {
    const mainCat = categoriaPrincipalEl.value;
    const subCats = CATEGORIAS_ANIDADAS[mainCat] || {};
    
    subCategoriaEl.innerHTML = '';
    
    Object.keys(subCats).forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      subCategoriaEl.appendChild(opt);
    });
    
    updateDisplay();
  }

  function initCategorias() {
    Object.keys(CATEGORIAS_ANIDADAS).forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categoriaPrincipalEl.appendChild(opt);
    });
    
    populateSubCategorias();
  }

  function parsePrice(value) {
    if (!value) return null;
    const normalized = String(value).trim().replace(/\s+/g, '').replace(',', '.');
    const v = Number(normalized);
    if (Number.isFinite(v) && v >= 0) return v;
    return null;
  }

  function formatCurrency(num) {
    if (num === null || num === undefined || !Number.isFinite(num)) return '—';
    return num.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 2 });
  }

  function showImpuestos() {
    if (Object.keys(appliedTaxes).length === 0) {
      impuestosAplicadosEl.textContent = '— No hay impuestos aplicados —';
      return;
    }
    const lines = Object.entries(appliedTaxes).map(([name, amount]) => `${name}: +${formatCurrency(amount)}`);
    impuestosAplicadosEl.innerHTML = '<small>' + lines.join('\n') + '</small>';
  }

  function updateDisplay() {
    // Primero, obtener el precio base si existe
    const parsedPrice = parsePrice(precioNetoEl.value);
    if (parsedPrice !== null) {
      netPrice = parsedPrice;
    }

    if (netPrice === null) {
      precioConImpuestosEl.textContent = '—';
      precioFinalEl.textContent = '—';
      margenTextoEl.textContent = '—';
      showImpuestos();
      return;
    }

    const totalTax = Object.values(appliedTaxes).reduce((a,b) => a + b, 0);
    const priceWithTaxes = netPrice + totalTax;

    const mainCat = categoriaPrincipalEl.value;
    const subCat = subCategoriaEl.value;

    if (!mainCat || !subCat) {
      precioFinalEl.textContent = '—';
      margenTextoEl.textContent = 'Seleccione categoría';
      precioConImpuestosEl.textContent = formatCurrency(priceWithTaxes); // Mostrar costo
      return;
    }

    const margin = CATEGORIAS_ANIDADAS[mainCat][subCat] ?? 0;
    const finalPrice = priceWithTaxes * (1 + margin);

    precioConImpuestosEl.textContent = formatCurrency(priceWithTaxes);
    precioFinalEl.textContent = formatCurrency(finalPrice);
    
    // Mostrar subcategoría con nombre más corto si es muy larga
    const subCatDisplay = subCat.length > 30 ? subCat.substring(0, 27) + '...' : subCat;
    margenTextoEl.textContent = `${(margin*100).toFixed(0)}% (${subCatDisplay})`;

    showImpuestos();
  }

  function applyTax(name, rate) {
    const parsed = parsePrice(precioNetoEl.value);
    if (parsed === null) {
      alert('Ingrese un precio neto válido antes de aplicar impuestos.');
      return;
    }
    netPrice = parsed; // Asegurarse de que netPrice esté actualizado

    if (appliedTaxes.hasOwnProperty(name)) {
      alert(`${name} ya fue aplicado.`);
      return;
    }
    const taxValue = netPrice * rate;
    appliedTaxes[name] = taxValue;
    updateDisplay();
  }

  async function downloadPdf() {
    const parsed = parsePrice(precioNetoEl.value);
     if (parsed === null) {
      alert('Debe ingresar un precio neto válido antes de generar el PDF.');
      return;
    }
    netPrice = parsed; // Asegurarse de que netPrice esté actualizado
    updateDisplay(); // Recalcular todo

    if (Object.keys(appliedTaxes).length === 0) {
       alert('Debe aplicar al menos un impuesto antes de generar el PDF.');
       return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
    const marginLeft = 48;
    let y = 72;

    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Detalle de Precios con Impuestos', 300, y, { align: 'center' });

    y += 36;
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');

    const now = new Date();
    doc.text(`Fecha y hora: ${now.toLocaleString('es-AR')}`, marginLeft, y);
    y += 20;
    doc.text(`Precio Neto: ${formatCurrency(netPrice)}`, marginLeft, y);
    y += 18;

    Object.entries(appliedTaxes).forEach(([name, amount]) => {
      doc.text(`${name}: +${formatCurrency(amount)}`, marginLeft, y);
      y += 16;
    });

    y += 6;
    const totalTax = Object.values(appliedTaxes).reduce((a,b) => a + b, 0);
    const priceWithTaxes = netPrice + totalTax;
    
    const mainCat = categoriaPrincipalEl.value;
    const subCat = subCategoriaEl.value;
    
    if (!mainCat || !subCat) {
        alert("Seleccione una categoría y sub-categoría válidas.");
        return;
    }

    const margin = CATEGORIAS_ANIDADAS[mainCat][subCat] ?? 0;
    const finalPrice = priceWithTaxes * (1 + margin);

    doc.text(`PRECIO COSTO (con impuestos): ${formatCurrency(priceWithTaxes)}`, marginLeft, y);
    y += 20;
    // Usar el nombre completo de la subcategoría para el PDF
    doc.text(`Margen aplicado (${subCat}): +${(margin*100).toFixed(0)}%`, marginLeft, y);
    y += 28;
    doc.setFont('helvetica', 'bold');
    doc.text(`PRECIO FINAL: ${formatCurrency(finalPrice)}`, marginLeft, y);
    y += 36;
    doc.setFont('helvetica', 'italic');
    doc.setFontSize(10);
    doc.text('Generado por Jesus Benitez', 300, y, { align: 'center' });

    const filename = `detalle_precios_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.pdf`;
    doc.save(filename);
  }

  // Eventos
  botonesImpuestos.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const name = btn.getAttribute('data-name');
      const rate = parseFloat(btn.getAttribute('data-rate'));
      applyTax(name, rate); // La función applyTax ahora obtiene el precio
    });
  });

  calcularBtn.addEventListener('click', () => {
    const parsed = parsePrice(precioNetoEl.value);
    if (parsed === null) {
      alert('Ingrese un precio neto válido (número positivo).');
      return;
    }
    netPrice = parsed;
    updateDisplay();
  });

  descargarPdfBtn.addEventListener('click', async () => {
    await downloadPdf();
  });

  limpiarBtn.addEventListener('click', () => {
    precioNetoEl.value = '';
    Object.keys(appliedTaxes).forEach(k => delete appliedTaxes[k]);
    netPrice = null;
    updateDisplay();
  });

  refrescarBtn.addEventListener('click', () => {
    precioNetoEl.value = '';
    Object.keys(appliedTaxes).forEach(k => delete appliedTaxes[k]);
    netPrice = null;
    
    categoriaPrincipalEl.selectedIndex = 0; 
    populateSubCategorias(); 
  });

  categoriaPrincipalEl.addEventListener('change', populateSubCategorias);
  subCategoriaEl.addEventListener('change', updateDisplay);
  
  // También actualiza el display si se cambia el precio
  precioNetoEl.addEventListener('input', updateDisplay);


  fullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.warn('No se pudo activar pantalla completa:', err);
      });
    } else {
      document.exitFullscreen();
    }
  });
  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape' && document.fullscreenElement) {
      document.exitFullscreen();
    }
  });

  // Inicialización
  initCategorias(); 
  updateDisplay();

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
